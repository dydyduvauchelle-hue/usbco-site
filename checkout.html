<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>USBCO — Paiement & Carte abonné</title>
  <link rel="icon" type="image/png" href="./assets/favicon.png" />
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- QR Code lib (client-side) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" integrity="sha512-4hI1YB3QwGx0Wg4L+YB5Xb8j3R3lZ3nXfH2n8fZ5d8Y0K1sYH6VvQb0o7m2j0cC3YkI2F0B3y1SgV6Jm6x7i2g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <!-- EmailJS (optionnel) -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <script>
    // REMPLIS CES IDENTIFIANTS SI TU VEUX L’ENVOI PAR EMAIL
    const EMAILJS_PUBLIC_KEY = "TA_PUBLIC_KEY";
    const EMAILJS_SERVICE_ID = "service_xxx";
    const EMAILJS_TEMPLATE_ID = "template_abonne";

    if (EMAILJS_PUBLIC_KEY) emailjs.init(EMAILJS_PUBLIC_KEY);
  </script>
</head>
<body class="bg-gray-100 text-gray-900">
  <!-- Header -->
  <header class="sticky top-0 z-50 bg-white/90 backdrop-blur border-b">
    <div class="max-w-7xl mx-auto flex justify-between items-center px-4 py-3">
      <a href="index.html" class="flex items-center gap-3 group">
        <img src="./assets/logo-usbco.png" alt="USBCO" class="h-12 w-12 rounded-lg border bg-white object-contain p-1 group-hover:opacity-90 transition" />
        <span class="font-bold text-xl text-red-700 group-hover:text-red-800 transition">US Boulogne Côte d’Opale</span>
      </a>
      <nav class="flex gap-6 items-center">
        <a href="matchs.html" class="hover:text-red-600">Matchs</a>
        <a href="billetterie.html?match=next-home" class="hover:text-red-600">Billetterie</a>
        <a href="abonnements.html" class="text-red-700 font-bold">Abonnements</a>
      </nav>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-10 grid md:grid-cols-5 gap-8">
    <!-- Col gauche : Formulaire -->
    <section class="md:col-span-3">
      <h1 class="text-3xl font-bold mb-2">Finaliser l’abonnement</h1>
      <p id="planLabel" class="text-gray-700 mb-6"></p>

      <form id="checkoutForm" class="space-y-4 bg-white p-6 rounded-2xl border shadow">
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">Nom complet</label>
            <input type="text" id="fullName" class="w-full border rounded-lg px-3 py-2" required placeholder="Jean Dupont"/>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">E-mail</label>
            <input type="email" id="email" class="w-full border rounded-lg px-3 py-2" required placeholder="jean@example.com"/>
          </div>
        </div>

        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">Photo (optionnelle)</label>
            <input type="file" id="photo" accept="image/*" class="w-full border rounded-lg px-3 py-2"/>
            <p class="text-xs text-gray-500 mt-1">Idéalement un portrait carré.</p>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Paiement (simulation)</label>
            <select class="w-full border rounded-lg px-3 py-2">
              <option>Carte bancaire</option>
              <option>Apple Pay</option>
              <option>Google Pay</option>
            </select>
          </div>
        </div>

        <div class="flex items-center gap-2">
          <input type="checkbox" id="terms" required/>
          <label for="terms" class="text-sm">J’accepte les CGV et la charte du supporter.</label>
        </div>

        <div class="flex flex-wrap gap-3">
          <button type="submit" class="px-5 py-2 rounded-lg bg-red-700 text-white hover:bg-red-800 transition">
            Payer et générer ma carte
          </button>
          <button type="button" id="sendEmailBtn" class="px-5 py-2 rounded-lg border border-red-700 text-red-700 hover:bg-red-700 hover:text-white transition hidden">
            M’envoyer par e-mail
          </button>
          <a id="downloadLink" href="#" download="usbco-carte-abonne.png"
             class="px-5 py-2 rounded-lg border hover:bg-gray-50 transition hidden">Télécharger la carte</a>
        </div>
      </form>
    </section>

    <!-- Col droite : Aperçu -->
    <aside class="md:col-span-2">
      <div class="bg-white p-6 rounded-2xl border shadow">
        <h2 class="font-bold mb-4">Aperçu de la carte</h2>
        <canvas id="cardCanvas" width="800" height="500" class="w-full border rounded"></canvas>
        <div id="qrTmp" class="hidden"></div>
        <p class="text-xs text-gray-500 mt-2">Un QR code unique est imprimé sur la carte. Il peut être scanné aux entrées.</p>
      </div>
    </aside>
  </main>

  <script>
    // ---------- Helpers ----------
    const params = new URLSearchParams(location.search);
    const plan = params.get('plan') || 'ribery';
    const priceCents = parseInt(params.get('price') || '18900', 10); // par défaut 189€
    const zone = params.get('zone') || 'ribery';

    const PLAN_LABELS = {
      'ribery': 'Tribune Franck Ribéry',
      'ouest-b': 'Tribune Ouest B',
      'boulanger': 'Tribune Boulanger'
    };

    const planLabelEl = document.getElementById('planLabel');
    planLabelEl.textContent = `${PLAN_LABELS[plan] || 'Abonnement'} — ${ (priceCents/100).toFixed(2).replace('.', ',') } €`;

    const form = document.getElementById('checkoutForm');
    const canvas = document.getElementById('cardCanvas');
    const ctx = canvas.getContext('2d');
    const downloadLink = document.getElementById('downloadLink');
    const sendEmailBtn = document.getElementById('sendEmailBtn');

    // ---------- Dessin carte ----------
    async function drawCard({ fullName, email, planName, zoneName, priceStr, photo }) {
      // fond
      ctx.fillStyle = '#111827';
      ctx.fillRect(0,0,800,500);

      // bande rouge
      ctx.fillStyle = '#b91c1c';
      ctx.fillRect(0,0,800,120);

      // logo
      const logo = await loadImage('./assets/logo-usbco.png').catch(() => null);
      if (logo) ctx.drawImage(logo, 24, 20, 80, 80);

      // titre
      ctx.fillStyle = '#fff';
      ctx.font = 'bold 28px Inter, system-ui, sans-serif';
      ctx.fillText('US BOULOGNE CÔTE D’OPALE — CARTE ABONNÉ', 120, 60);

      // sous-titre
      ctx.font = '18px Inter, system-ui, sans-serif';
      ctx.fillText(`${planName} — Zone: ${zoneName.toUpperCase()}`, 120, 90);

      // bloc infos
      ctx.fillStyle = '#f9fafb';
      roundRect(ctx, 24, 140, 480, 200, 12, true, false);
      ctx.fillStyle = '#111827';
      ctx.font = 'bold 22px Inter, system-ui, sans-serif';
      ctx.fillText(fullName, 40, 180);
      ctx.font = '16px Inter, system-ui, sans-serif';
      ctx.fillText(email, 40, 210);
      ctx.fillText(`Saison: 2025-2026`, 40, 240);
      ctx.fillText(`Tarif: ${priceStr}`, 40, 270);
      ctx.fillText(`ID: ${genId(email)}`, 40, 300);

      // photo (optionnelle)
      if (photo) {
        ctx.save();
        circleClip(ctx, 560, 190, 60);
        ctx.drawImage(photo, 500, 130, 120, 120);
        ctx.restore();
      } else {
        // placeholder
        ctx.fillStyle = '#374151';
        circle(ctx, 560, 190, 60);
        ctx.fillStyle = '#9ca3af';
        ctx.font = '14px Inter, system-ui, sans-serif';
        ctx.fillText('Photo', 540, 195);
      }

      // QR code
      const qrContainer = document.getElementById('qrTmp');
      qrContainer.innerHTML = '';
      const qrData = `USBCO|${genId(email)}|${plan}|${zone}`;
      const qr = new QRCode(qrContainer, { text: qrData, width: 128, height: 128, margin: 0 });
      await new Promise(r => setTimeout(r, 200)); // laisse le temps de générer
      const qrImg = qrContainer.querySelector('img');
      if (qrImg && qrImg.src) {
        const qrBitmap = await loadImage(qrImg.src);
        ctx.drawImage(qrBitmap, 620, 320, 150, 150);
      }

      // mini plan du stade (juste un repère visuel)
      ctx.fillStyle = '#111827';
      ctx.fillRect(24, 360, 260, 120);
      ctx.fillStyle = '#b91c1c';
      ctx.fillRect(24, 360, 260, 36);
      ctx.fillStyle = '#e5e7eb';
      ctx.font = '12px Inter, system-ui, sans-serif';
      ctx.fillText('Plan de repérage — zone sélectionnée', 30, 350);

      // badge zone
      ctx.fillStyle = '#fef3c7';
      roundRect(ctx, 300, 360, 300, 40, 10, true, false);
      ctx.fillStyle = '#92400e';
      ctx.font = 'bold 16px Inter, system-ui, sans-serif';
      ctx.fillText(`Zone: ${zoneName.toUpperCase()} — Accès domicile L2`, 314, 386);
    }

    function genId(email){
      const base = (email || 'x').toLowerCase().replace(/[^a-z0-9]/g,'');
      return (base.slice(0,6) + Date.now().toString().slice(-6)).toUpperCase();
    }

    function roundRect(ctx, x, y, w, h, r, fill, stroke) {
      ctx.beginPath();
      ctx.moveTo(x+r, y);
      ctx.arcTo(x+w, y, x+w, y+h, r);
      ctx.arcTo(x+w, y+h, x, y+h, r);
      ctx.arcTo(x, y+h, x, y, r);
      ctx.arcTo(x, y, x+w, y, r);
      ctx.closePath();
      if (fill) ctx.fill();
      if (stroke) ctx.stroke();
    }
    function circle(ctx, x, y, r){ ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill(); }
    function circleClip(ctx, x, y, r){ ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.clip(); }

    function loadImage(src){
      return new Promise((resolve, reject)=>{
        const img = new Image();
        img.crossOrigin = "anonymous";
        img.onload = () => resolve(img);
        img.onerror = reject;
        img.src = src;
      });
    }

    // ---------- Submit ----------
    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const fullName = document.getElementById('fullName').value.trim();
      const email = document.getElementById('email').value.trim();
      const photoFile = document.getElementById('photo').files[0] || null;

      let photoImage = null;
      if (photoFile) {
        const reader = new FileReader();
        const img = await new Promise((res, rej)=>{
          reader.onload = () => {
            const i = new Image();
            i.onload = () => res(i);
            i.onerror = rej;
            i.src = reader.result;
          };
          reader.onerror = rej;
          reader.readAsDataURL(photoFile);
        });
        photoImage = img;
      }

      const priceStr = (priceCents/100).toFixed(2).replace('.', ',') + ' €';
      await drawCard({
        fullName,
        email,
        planName: PLAN_LABELS[plan] || 'Abonnement',
        zoneName: zone,
        priceStr,
        photo: photoImage
      });

      // Téléchargement
      const dataURL = canvas.toDataURL('image/png');
      downloadLink.href = dataURL;
      downloadLink.classList.remove('hidden');

      // Si EmailJS est configuré, on affiche le bouton envoi
      if (EMAILJS_PUBLIC_KEY && EMAILJS_SERVICE_ID && EMAILJS_TEMPLATE_ID) {
        sendEmailBtn.classList.remove('hidden');
        sendEmailBtn.onclick = async ()=>{
          try {
            await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, {
              to_email: email,
              to_name: fullName,
              plan: PLAN_LABELS[plan] || 'Abonnement',
              zone: zone.toUpperCase(),
              price: priceStr,
              card_png_base64: dataURL, // ton template EmailJS doit avoir une variable pour ça
            });
            alert('📩 Carte envoyée par e-mail !');
          } catch (err) {
            console.error(err);
            alert("L'envoi d'e-mail a échoué. Vérifie la configuration EmailJS.");
          }
        };
      } else {
        // Si pas EmailJS, proposer un mailto (fallback simple)
        sendEmailBtn.classList.add('hidden');
      }

      alert('✅ Paiement simulé. Ta carte est prête : tu peux la télécharger, et/ou te l’envoyer par e-mail.');
    });
  </script>
</body>
</html>
