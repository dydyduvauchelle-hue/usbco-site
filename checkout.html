<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>USBCO — Paiement & Carte abonné</title>
  <link rel="icon" type="image/png" href="./assets/favicon.png" />
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- QR Code lib (client-side) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" integrity="sha512-4hI1YB3QwGx0Wg4L+YB5Xb8j3R3lZ3nXfH2n8fZ5d8Y0K1sYH6VvQb0o7m2j0cC3YkI2F0B3y1SgV6Jm6x7i2g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <!-- EmailJS (optionnel) -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <script>
    // REMPLIS CES IDENTIFIANTS SI TU VEUX L’ENVOI PAR EMAIL
    const EMAILJS_PUBLIC_KEY = "";      // ex: "W1AbCxyz..."
    const EMAILJS_SERVICE_ID = "";      // ex: "service_usbco"
    const EMAILJS_TEMPLATE_ID = "";     // ex: "template_abonne"

    if (EMAILJS_PUBLIC_KEY) emailjs.init(EMAILJS_PUBLIC_KEY);
  </script>
</head>
<body class="bg-gray-100 text-gray-900">
  <!-- Header -->
  <header class="sticky top-0 z-50 bg-white/90 backdrop-blur border-b">
    <div class="max-w-7xl mx-auto flex justify-between items-center px-4 py-3">
      <a href="index.html" class="flex items-center gap-3 group">
        <img src="./assets/logo-usbco.png" alt="USBCO" class="h-12 w-12 rounded-lg border bg-white object-contain p-1 group-hover:opacity-90 transition" />
        <span class="font-bold text-xl text-red-700 group-hover:text-red-800 transition">US Boulogne Côte d’Opale</span>
      </a>
      <nav class="flex gap-6 items-center">
        <a href="matchs.html" class="hover:text-red-600">Matchs</a>
        <a href="billetterie.html?match=next-home" class="hover:text-red-600">Billetterie</a>
        <a href="abonnements.html" class="text-red-700 font-bold">Abonnements</a>
      </nav>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-10 grid md:grid-cols-5 gap-8">
    <!-- Col gauche : Formulaire -->
    <section class="md:col-span-3">
      <h1 class="text-3xl font-bold mb-2">Finaliser l’abonnement</h1>
      <p id="planLabel" class="text-gray-700 mb-6"></p>

      <form id="checkoutForm" class="space-y-4 bg-white p-6 rounded-2xl border shadow">
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">Nom complet</label>
            <input type="text" id="fullName" class="w-full border rounded-lg px-3 py-2" required placeholder="Jean Dupont"/>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">E-mail</label>
            <input type="email" id="email" class="w-full border rounded-lg px-3 py-2" required placeholder="jean@example.com"/>
          </div>
        </div>

        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">Photo (optionnelle)</label>
            <input type="file" id="photo" accept="image/*" class="w-full border rounded-lg px-3 py-2"/>
            <p class="text-xs text-gray-500 mt-1">Idéalement un portrait carré.</p>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Paiement (simulation)</label>
            <select class="w-full border rounded-lg px-3 py-2">
              <option>Carte bancaire</option>
              <option>Apple Pay</option>
              <option>Google Pay</option>
            </select>
          </div>
        </div>

        <div class="flex items-center gap-2">
          <input type="checkbox" id="terms" required/>
          <label for="terms" class="text-sm">J’accepte les CGV et la charte du supporter.</label>
        </div>

        <div class="flex flex-wrap gap-3">
          <button type="submit" class="px-5 py-2 rounded-lg bg-red-700 text-white hover:bg-red-800 transition">
            Payer et générer ma carte
          </button>
          <button type="button" id="sendEmailBtn" class="px-5 py-2 rounded-lg border border-red-700 text-red-700 hover:bg-red-700 hover:text-white transition hidden">
            M’envoyer par e-mail
          </button>
          <a id="downloadLink" href="#" download="usbco-carte-abonne.png"
             class="px-5 py-2 rounded-lg border hover:bg-gray-50 transition hidden">Télécharger la carte</a>
        </div>
      </form>
    </section>

    <!-- Col droite : Aperçu -->
    <aside class="md:col-span-2">
      <div class="bg-white p-6 rounded-2xl border shadow">
        <h2 class="font-bold mb-4">Aperçu de la carte</h2>
        <canvas id="cardCanvas" width="800" height="500" class="w-full border rounded"></canvas>
        <div id="qrTmp" class="hidden"></div>
        <p class="text-xs text-gray-500 mt-2">Un QR code unique est imprimé sur la carte. Il peut être scanné aux entrées.</p>
      </div>
    </aside>
  </main>

  <script>
    // ---------- Helpers ----------
    const params = new URLSearchParams(location.search);
    const plan = params.get('plan') || 'ribery';
    const priceCents = parseInt(params.get('price') || '18900', 10); // par défaut 189€
    const zone = params.get('zone') || 'ribery';

    const PLAN_LABELS = {
      'ribery': 'Tribune Franck Ribéry',
      'ouest-b': 'Tribune Ouest B',
      'boulanger'
