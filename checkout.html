<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>USBCO ‚Äî Paiement & Carte abonn√©</title>
  <link rel="icon" type="image/png" href="./assets/favicon.png" />
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- QR Code lib -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <!-- jsPDF pour re√ßu PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <!-- EmailJS (optionnel) -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <script>
    // REMPLIS si tu veux l‚Äôenvoi email
    const EMAILJS_PUBLIC_KEY = "";      // ex: "W1AbCxyz..."
    const EMAILJS_SERVICE_ID = "";      // ex: "service_usbco"
    const EMAILJS_TEMPLATE_ID = "";     // ex: "template_abonne"
    if (EMAILJS_PUBLIC_KEY) emailjs.init(EMAILJS_PUBLIC_KEY);
  </script>
</head>
<body class="bg-gray-100 text-gray-900">
  <!-- Header -->
  <header class="sticky top-0 z-50 bg-white/90 backdrop-blur border-b">
    <div class="max-w-7xl mx-auto flex justify-between items-center px-4 py-3">
      <a href="index.html" class="flex items-center gap-3 group">
        <img src="./assets/logo-usbco.png" alt="USBCO" class="h-12 w-12 rounded-lg border bg-white object-contain p-1 group-hover:opacity-90 transition" />
        <span class="font-bold text-xl text-red-700 group-hover:text-red-800 transition">US Boulogne C√¥te d‚ÄôOpale</span>
      </a>
      <nav class="flex gap-6 items-center">
        <a href="matchs.html" class="hover:text-red-600">Matchs</a>
        <a href="billetterie.html?match=next-home" class="hover:text-red-600">Billetterie</a>
        <a href="abonnements.html" class="text-red-700 font-bold">Abonnements</a>
      </nav>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-10 grid lg:grid-cols-5 gap-8">
    <!-- Formulaire -->
    <section class="lg:col-span-3">
      <h1 class="text-3xl font-bold mb-2">Finaliser l‚Äôabonnement</h1>
      <p id="planLabel" class="text-gray-700 mb-6"></p>

      <form id="checkoutForm" class="space-y-4 bg-white p-6 rounded-2xl border shadow">
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">Nom complet</label>
            <input type="text" id="fullName" class="w-full border rounded-lg px-3 py-2" required placeholder="Jean Dupont"/>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">E-mail</label>
            <input type="email" id="email" class="w-full border rounded-lg px-3 py-2" required placeholder="jean@example.com"/>
          </div>
        </div>

        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">Photo (optionnelle)</label>
            <input type="file" id="photo" accept="image/*" class="w-full border rounded-lg px-3 py-2"/>
            <p class="text-xs text-gray-500 mt-1">Id√©alement un portrait carr√©.</p>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Paiement (simulation)</label>
            <select class="w-full border rounded-lg px-3 py-2">
              <option>Carte bancaire</option>
              <option>Apple Pay</option>
              <option>Google Pay</option>
            </select>
          </div>
        </div>

        <div class="flex items-center gap-2">
          <input type="checkbox" id="terms" required/>
          <label for="terms" class="text-sm">J‚Äôaccepte les CGV et la charte du supporter.</label>
        </div>

        <div class="flex flex-wrap gap-3">
          <button type="submit" class="px-5 py-2 rounded-lg bg-red-700 text-white hover:bg-red-800 transition">
            Payer et g√©n√©rer ma carte
          </button>
          <a id="downloadLink" href="#" download="usbco-carte-abonne.png"
             class="px-5 py-2 rounded-lg border hover:bg-gray-50 transition hidden">T√©l√©charger la carte</a>
          <button type="button" id="pdfBtn" class="px-5 py-2 rounded-lg border hover:bg-gray-50 transition hidden">
            T√©l√©charger le re√ßu PDF
          </button>
          <button type="button" id="sendEmailBtn" class="px-5 py-2 rounded-lg border border-red-700 text-red-700 hover:bg-red-700 hover:text-white transition hidden">
            M‚Äôenvoyer par e-mail
          </button>
        </div>
      </form>

      <!-- Historique -->
      <div class="mt-8 bg-white p-6 rounded-2xl border shadow">
        <div class="flex items-center justify-between">
          <h2 class="font-bold">Historique de mes abonnements</h2>
          <button id="clearHistory" class="text-sm text-red-700 hover:underline">Vider l‚Äôhistorique</button>
        </div>
        <div id="historyBox" class="mt-4 text-sm text-gray-700"></div>
      </div>
    </section>

    <!-- Aper√ßu carte -->
    <aside class="lg:col-span-2">
      <div class="bg-white p-6 rounded-2xl border shadow">
        <h2 class="font-bold mb-4">Aper√ßu de la carte</h2>
        <canvas id="cardCanvas" width="800" height="500" class="w-full border rounded"></canvas>
        <div id="qrTmp" class="hidden"></div>
        <p class="text-xs text-gray-500 mt-2">Un QR code unique est imprim√© sur la carte. Il peut √™tre scann√© aux entr√©es.</p>
      </div>
    </aside>
  </main>

  <script>
    // ---------- Params URL ----------
    const params = new URLSearchParams(location.search);
    const plan = params.get('plan') || 'ribery';
    const priceCents = parseInt(params.get('price') || '18900', 10);
    const zone = params.get('zone') || 'ribery';

    const PLAN_LABELS = {
      'ribery': 'Tribune Franck Rib√©ry',
      'ouest-b': 'Tribune Ouest B',
      'boulanger': 'Tribune Boulanger'
    };
    const planLabelEl = document.getElementById('planLabel');
    planLabelEl.textContent = `${PLAN_LABELS[plan] || 'Abonnement'} ‚Äî ${(priceCents/100).toFixed(2).replace('.', ',')} ‚Ç¨`;

    // ---------- Elements ----------
    const form = document.getElementById('checkoutForm');
    const canvas = document.getElementById('cardCanvas');
    const ctx = canvas.getContext('2d');
    const downloadLink = document.getElementById('downloadLink');
    const pdfBtn = document.getElementById('pdfBtn');
    const sendEmailBtn = document.getElementById('sendEmailBtn');
    const historyBox = document.getElementById('historyBox');
    const clearHistoryBtn = document.getElementById('clearHistory');

    // ---------- Utils ----------
    function genRef() {
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      const rnd = Math.random().toString(16).slice(2,7).toUpperCase();
      return `USBCO-${y}${m}${day}-${rnd}`;
    }
    function genId(email){
      const base = (email || 'x').toLowerCase().replace(/[^a-z0-9]/g,'');
      return (base.slice(0,6) + Date.now().toString().slice(-6)).toUpperCase();
    }
    function roundRect(ctx, x, y, w, h, r, fill, stroke) {
      ctx.beginPath();
      ctx.moveTo(x+r, y);
      ctx.arcTo(x+w, y, x+w, y+h, r);
      ctx.arcTo(x+w, y+h, x, y+h, r);
      ctx.arcTo(x, y+h, x, y, r);
      ctx.arcTo(x, y, x+w, y, r);
      ctx.closePath();
      if (fill) ctx.fill();
      if (stroke) ctx.stroke();
    }
    function circle(ctx, x, y, r){ ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill(); }
    function circleClip(ctx, x, y, r){ ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.clip(); }
    function loadImage(src){
      return new Promise((resolve, reject)=>{
        const img = new Image(); img.crossOrigin = "anonymous";
        img.onload = () => resolve(img); img.onerror = reject; img.src = src;
      });
    }

    // ---------- Carte ----------
    async function drawCard({ fullName, email, planName, zoneName, priceStr, photo, orderRef }) {
      ctx.fillStyle = '#111827'; ctx.fillRect(0,0,800,500);
      ctx.fillStyle = '#b91c1c'; ctx.fillRect(0,0,800,120);

      const logo = await loadImage('./assets/logo-usbco.png').catch(() => null);
      if (logo) ctx.drawImage(logo, 24, 20, 80, 80);

      ctx.fillStyle = '#fff';
      ctx.font = 'bold 28px Inter, system-ui, sans-serif';
      ctx.fillText('US BOULOGNE C√îTE D‚ÄôOPALE ‚Äî CARTE ABONN√â', 120, 60);

      ctx.font = '18px Inter, system-ui, sans-serif';
      ctx.fillText(`${planName} ‚Äî Zone: ${zoneName.toUpperCase()}`, 120, 90);

      ctx.fillStyle = '#f9fafb';
      roundRect(ctx, 24, 140, 480, 200, 12, true, false);
      ctx.fillStyle = '#111827';
      ctx.font = 'bold 22px Inter, system-ui, sans-serif';
      ctx.fillText(fullName, 40, 180);
      ctx.font = '16px Inter, system-ui, sans-serif';
      ctx.fillText(email, 40, 210);
      ctx.fillText(`Saison: 2025-2026`, 40, 240);
      ctx.fillText(`Tarif: ${priceStr}`, 40, 270);
      ctx.fillText(`R√©f√©rence: ${orderRef}`, 40, 300);

      if (photo) {
        ctx.save(); circleClip(ctx, 560, 190, 60);
        ctx.drawImage(photo, 500, 130, 120, 120); ctx.restore();
      } else {
        ctx.fillStyle = '#374151'; circle(ctx, 560, 190, 60);
        ctx.fillStyle = '#9ca3af'; ctx.font = '14px Inter, system-ui, sans-serif'; ctx.fillText('Photo', 540, 195);
      }

      // QR code data
      const qrData = `USBCO|${orderRef}|${plan}|${zone}|${email}`;
      const qrContainer = document.getElementById('qrTmp');
      qrContainer.innerHTML = '';
      const qr = new QRCode(qrContainer, { text: qrData, width: 128, height: 128, margin: 0 });
      await new Promise(r => setTimeout(r, 200));
      const qrImg = qrContainer.querySelector('img');
      if (qrImg && qrImg.src) {
        const qrBitmap = await loadImage(qrImg.src);
        ctx.drawImage(qrBitmap, 620, 320, 150, 150);
      }

      ctx.fillStyle = '#111827'; ctx.fillRect(24, 360, 260, 120);
      ctx.fillStyle = '#b91c1c'; ctx.fillRect(24, 360, 260, 36);
      ctx.fillStyle = '#e5e7eb'; ctx.font = '12px Inter, system-ui, sans-serif';
      ctx.fillText('Plan de rep√©rage ‚Äî zone s√©lectionn√©e', 30, 350);

      ctx.fillStyle = '#fef3c7'; roundRect(ctx, 300, 360, 300, 40, 10, true, false);
      ctx.fillStyle = '#92400e'; ctx.font = 'bold 16px Inter, system-ui, sans-serif';
      ctx.fillText(`Zone: ${zoneName.toUpperCase()} ‚Äî Acc√®s domicile L2`, 314, 386);
    }

    // ---------- Historique ----------
    function loadHistory(){
      const raw = localStorage.getItem('usbco_subs');
      return raw ? JSON.parse(raw) : [];
    }
    function saveHistory(entry){
      const arr = loadHistory();
      arr.unshift(entry);
      localStorage.setItem('usbco_subs', JSON.stringify(arr.slice(0,50)));
    }
    function renderHistory(){
      const arr = loadHistory();
      if (!arr.length) { historyBox.innerHTML = `<p class="text-gray-500">Aucun abonnement enregistr√© pour le moment.</p>`; return; }
      historyBox.innerHTML = `
        <div class="overflow-x-auto">
          <table class="min-w-full text-left">
            <thead>
              <tr class="text-xs uppercase text-gray-500">
                <th class="py-2 pr-4">Date</th>
                <th class="py-2 pr-4">R√©f.</th>
                <th class="py-2 pr-4">Nom</th>
                <th class="py-2 pr-4">Plan</th>
                <th class="py-2 pr-4">Zone</th>
                <th class="py-2 pr-4">Prix</th>
              </tr>
            </thead>
            <tbody>
              ${arr.map(e => `
                <tr class="border-t">
                  <td class="py-2 pr-4">${new Date(e.createdAt).toLocaleString('fr-FR')}</td>
                  <td class="py-2 pr-4">${e.orderRef}</td>
                  <td class="py-2 pr-4">${e.fullName}</td>
                  <td class="py-2 pr-4">${e.planName}</td>
                  <td class="py-2 pr-4">${e.zone.toUpperCase()}</td>
                  <td class="py-2 pr-4">${e.priceStr}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    }
    clearHistoryBtn.addEventListener('click', ()=>{
      if (confirm('Supprimer l‚Äôhistorique local ?')) {
        localStorage.removeItem('usbco_subs'); renderHistory();
      }
    });
    renderHistory();

    // ---------- Submit ----------
    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const fullName = document.getElementById('fullName').value.trim();
      const email = document.getElementById('email').value.trim();
      const photoFile = document.getElementById('photo').files[0] || null;

      let photoImage = null;
      if (photoFile) {
        const reader = new FileReader();
        const img = await new Promise((res, rej)=>{
          reader.onload = () => { const i = new Image(); i.onload = () => res(i); i.onerror = rej; i.src = reader.result; };
          reader.onerror = rej; reader.readAsDataURL(photoFile);
        });
        photoImage = img;
      }

      const priceStr = (priceCents/100).toFixed(2).replace('.', ',') + ' ‚Ç¨';
      const orderRef = genRef();

      await drawCard({
        fullName,
        email,
        planName: PLAN_LABELS[plan] || 'Abonnement',
        zoneName: zone,
        priceStr,
        photo: photoImage,
        orderRef
      });

      // T√©l√©chargement image
      const dataURL = canvas.toDataURL('image/png');
      downloadLink.href = dataURL;
      downloadLink.classList.remove('hidden');

      // PDF bouton
      pdfBtn.classList.remove('hidden');
      pdfBtn.onclick = async ()=>{
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ unit: 'pt', format: 'a4' });
        const now = new Date();

        // Titre
        doc.setFont('helvetica','bold'); doc.setFontSize(18);
        doc.text('Re√ßu d‚Äôabonnement ‚Äî US Boulogne C√¥te d‚ÄôOpale', 40, 50);

        // Infos
        doc.setFont('helvetica',''); doc.setFontSize(12);
        doc.text(`R√©f√©rence : ${orderRef}`, 40, 80);
        doc.text(`Nom       : ${fullName}`, 40, 100);
        doc.text(`Email     : ${email}`, 40, 120);
        doc.text(`Plan      : ${PLAN_LABELS[plan] || 'Abonnement'}`, 40, 140);
        doc.text(`Zone      : ${zone.toUpperCase()}`, 40, 160);
        doc.text(`Prix      : ${priceStr}`, 40, 180);
        doc.text(`Date      : ${now.toLocaleString('fr-FR')}`, 40, 200);

        // Carte en image
        doc.addImage(dataURL, 'PNG', 40, 230, 515, 322); // largeur A4 utile ~ 515pt

        doc.save(`USBCO-recu-${orderRef}.pdf`);
      };

      // Email ?
      if (EMAILJS_PUBLIC_KEY && EMAILJS_SERVICE_ID && EMAILJS_TEMPLATE_ID) {
        sendEmailBtn.classList.remove('hidden');
        sendEmailBtn.onclick = async ()=>{
          try {
            await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, {
              to_email: email,
              to_name: fullName,
              plan: PLAN_LABELS[plan] || 'Abonnement',
              zone: zone.toUpperCase(),
              price: priceStr,
              card_png_base64: dataURL,
              order_ref: orderRef
            });
            alert('üì© Carte envoy√©e par e-mail !');
          } catch (err) {
            console.error(err);
            alert("L'envoi d'e-mail a √©chou√©. V√©rifie ta configuration EmailJS.");
          }
        };
      } else {
        sendEmailBtn.classList.add('hidden');
      }

      // Sauvegarde historique local
      saveHistory({
        createdAt: Date.now(),
        orderRef,
        fullName,
        email,
        plan,
        planName: PLAN_LABELS[plan] || 'Abonnement',
        zone,
        priceStr
      });
      renderHistory();

      alert('‚úÖ Paiement simul√©. Ta carte est pr√™te : t√©l√©charge-la, re√ßois un PDF et/ou un e-mail.');
    });
  </script>
</body>
</html>
